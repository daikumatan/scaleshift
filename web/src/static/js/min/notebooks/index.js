var notebooks=[],conditions={firstLoad:!0,words:"",order:1},vue=new Vue({el:"#data",data:{notebooks:[]},methods:{train:function(o){var t=$(o.target).closest("li");training.id=t.attr("data-id"),training.name=t.find(".notebook-name").text(),training.cmd="";var s=$("#training-dialog");s.find(".form-group.considerable div").css({opacity:0}),s.find(".btn").addClass("disabled"),s.find(".training-notebook select").html(""),s.modal("open");var d=!1,i=!1;function r(){d&&i&&(s.find(".form-group.considerable div").animate({opacity:1},500),s.find(".btn").removeClass("disabled"))}API("Notebook").getIPythonNotebooks(training.id,function(o,t,e){if(!app.shouldExit(e,o)){e.body.sort(function(o,t){return o.name<t.name?-1:o.name>t.name?1:0});var n="";$.map(e.body,function(o){n+='<option value="'+o.name+'">'+o.name+"</option>"}),""==n&&(n+='<option value="none">There is no notebook in your workspace.</option>');var i=s.find(".training-type select"),a=s.find(".training-notebook select").html(n);0==e.body.length?(i.val("1").prop("disabled",!0),a.prop("disabled",!0),s.find(".training-cmds").focus(),training.cmd=""):(i.val("0").removeProp("disabled"),a.removeProp("disabled"),training.cmd="python <converted-notebook.py>"),i.formSelect(),a.formSelect(),d=!0,r()}}),API("Rescale").getCoreTypes({appVer:"cpu:cheap"},function(o,t,e){if(app.shouldExit(e,o)||e&&e.body&&401==e.body.code)return alert("Something went wrong. Check your configurations!"),void(window.location.href="/settings/");var n="";0<e.body.length&&$.map(e.body[0].resources,function(o){var t=0<o.gpus?", GPU: "+o.gpus:"";n+='<option value="'+o.cores+'">CPU cores: '+o.cores+t+"</option>"}),s.find(".training-cores select").html(n).formSelect(),i=!0,r()})},stop:function(o){confirmation.action="STOP",confirmation.id=app.trim($(o.target).closest("li").attr("data-id")),confirmation.name=$(o.target).closest("li").find(".notebook-name").text(),$("#notebook-modify").modal("open")},del:function(o){confirmation.action="DELETE",confirmation.id=app.trim($(o.target).closest("li").attr("data-id")),confirmation.name=$(o.target).closest("li").find(".notebook-name").text(),$("#notebook-modify").modal("open")},update:function(){var t=[];$.map(notebooks,function(o){(""==conditions.words||app.match([o.image,o.name],conditions.words))&&"created"!=o.state&&t.push(o)}),t.sort(function(o,t){if(1==conditions.order){if(o.image<t.image)return-1;if(o.image>t.image)return 1}var e=new Date(t.started).getTime()-new Date(o.started).getTime();return 0!=e?e:o.image<t.image?-1:o.image>t.image?1:0});var e=[];$.map(t,function(o){var t=o.port?window.location.protocol+"//"+window.location.hostname+":"+o.port:"";e.push({id:o.id,name:o.name.substring(1),image:o.image,url:t,state:o.state,started:app.date.format(new Date(o.started)),classObject:statusClass(o.state)})}),this.notebooks=e,conditions.firstLoad&&(conditions.firstLoad=!1,""!=conditions.words&&0<e.length&&setTimeout(function(){$("#query-words").blur()},500)),$("#record-count").text(e.length)}}});function statusClass(o){switch(o){case"running":return{"label-success":!0,"label-warning":!1,"label-danger":!1};case"creating":return{"label-success":!1,"label-warning":!0,"label-danger":!1};case"exited":return{"label-success":!1,"label-warning":!1,"label-danger":!0}}return{"label-success":!1,"label-warning":!1,"label-danger":!0}}function update(){conditions.words=app.singleSpace($("#query-words").val()),conditions.order=parseInt($("#query-order-type").val(),10),vue.update()}function load(n){API("Notebook").getNotebooks(function(o,t,e){$.isEmptyObject(o)&&e&&e.body&&(notebooks=e.body,update(),n&&n())})}function loadDetails(s){if(!$(s).attr("data-loaded")){var o=$(s).attr("data-id");API("Notebook").getNotebookDetails(o,function(o,t,e){if(!app.shouldExit(e,o)){var n=$("a.endpoint",s);if(!e.body.token)return setTimeout(function(){loadDetails(s)},1e3),void n.prop("href","");n.prop("href",s.closest("li").attr("data-url")+"?token="+e.body.token),$(".notebook-name",s).text(e.body.name.substring(1)),$(".notebook-started",s).text(app.date.format(new Date(e.body.started)));var i="-";"exited"==e.body.state&&(i=app.date.format(new Date(e.body.ended))),$(".notebook-ended",s).text(i);var a=0<e.body.mounts.length?e.body.mounts[0]:"";0<a.indexOf(":")&&(a=a.split(":"),a='<a href="/workspaces/?q='+encodeURIComponent(a[0])+'">'+a[0]+"</a>:"+a[1]),$(".notebook-volumes",s).html(a),$(s).attr("data-loaded","done")}})}}var training=new Vue({el:"#training-dialog",data:{id:"",name:"",cmd:""},methods:{submit:function(){setTimeout(function(){$(".btn").blur()},500),$("form p.errors").show();var o=$("#training-dialog"),t=app.singleSpace(this.cmd).split(" ");if(!t||0==t.length||""==t[0])return M.toast({html:"You have to specify its commands.",displayLength:3e3}),void o.find(".training-cmds").focus();o.modal("close");var e=o.find(".training-notebook select").val();"1"==o.find(".training-type select").val()&&(e="none");var n=models.JobAttrs.constructFromObject({notebook_id:this.id,entrypoint_file:e,commands:t,coretype:o.find(".training-coretype select").val(),cores:parseInt(o.find(".training-cores select").val(),10)});API("Job").postNewJob(n,function(o,t,e){if(!$.isEmptyObject(o))return e&&e.body&&e.body.code&&"400"==e.body.code&&e.body.message?void M.toast({html:"Could not start training with this notebook",displayLength:3e3}):e&&e.body&&e.body.code&&"406"==e.body.code&&e.body.message?void M.toast({html:"GPU is not allowed yet",displayLength:3e3}):app.shouldExit(e,o)?(alert("Something went wrong. Check your configurations!"),void(window.location.href="/settings/")):void 0;location.href="/jobs/?q="+encodeURIComponent(e.body.id)})},error:function(o){this.msgCmd=o},close:function(){$("#training-dialog").modal("close")}}}),confirmation=new Vue({el:"#notebook-modify",data:{action:"STOP",id:"",name:""},methods:{exec:function(){switch($("#notebook-modify").modal("close"),this.action){case"STOP":var o=models.NotebookAttrs.constructFromObject({status:"stopped"});API("Notebook").modifyNotebook(this.id,o,function(o,t,e){if(!$.isEmptyObject(o)){var n="Could not stop the specified notebook";return e&&e.body&&e.body.message&&(n=e.body.message),void M.toast({html:n,displayLength:3e3})}M.toast({html:"Stoped successfully. [ "+confirmation.name+" ]",displayLength:3e3}),load()});break;case"DELETE":API("Notebook").deleteNotebook(this.id,function(o,t,e){if(!$.isEmptyObject(o)){var n="Could not delete the specified notebook";return e&&e.body&&e.body.message&&(n=e.body.message),void M.toast({html:n,displayLength:3e3})}M.toast({html:"Deleted successfully. [ "+confirmation.name+" ]",displayLength:3e3}),load()})}},close:function(){$("#notebook-modify").modal("close")}}});$(document).ready(function(){$("#menu-notebooks").addClass("active"),app.query("q")&&$("#query-words").val(app.query("q")).focus(),$(".collapsible").on("shown.bs.collapse",function(o){loadDetails($(o.target).closest("li"))}),load(function(){$("#query-words").keyup(function(){update()}),$("#query-order-type").change(function(){update()}),$("#training-dialog .training-type select").on("change",function(){var o=$("#training-dialog");"1"==$(this).val()?(o.find(".training-notebook select").prop("disabled",!0).formSelect(),o.find(".training-cmds").focus(),training.cmd=""):(o.find(".training-notebook select").removeProp("disabled").formSelect(),training.cmd="python <converted-notebook.py>")}),$("#training-dialog .training-coretype select").on("change",function(){var i=$("#training-dialog"),o="cpu:cheap";"dolomite"==$(this).val()&&(o="gpu:volta"),API("Rescale").getCoreTypes({appVer:o},function(o,t,e){if(app.shouldExit(e,o)||e&&e.body&&401==e.body.code)return alert("Something went wrong. Check your configurations!"),void(window.location.href="/settings/");var n="";0<e.body.length&&$.map(e.body[0].resources,function(o){var t=0<o.gpus?", GPU: "+o.gpus:"";n+='<option value="'+o.cores+'">CPU cores: '+o.cores+t+"</option>"}),i.find(".training-cores select").html(n).formSelect()})}),$("#data").fadeIn()}),setInterval(load,3e3)});