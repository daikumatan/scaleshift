var notebooks=[],conditions={firstLoad:!0,words:"",order:1},vue=new Vue({el:"#data",data:{notebooks:[],trainOnCloud:!1},methods:{train:function(o){var e=$(o.target).closest("li");training.id=e.attr("data-id"),training.name=e.find(".notebook-name").text(),training.cmd="",training.cpus=1e3,training.gpus=0;var s=$("#training-dialog");s.find(".form-group.considerable div").css({opacity:0}),s.find(".btn").addClass("disabled"),s.find(".training-notebook select").html(""),s.modal("open"),s.css({opacity:0,display:"none"}),setTimeout(function(){s.css({opacity:0,display:"none"})},50);var t=config.get();t.useRescale&&t.useKubernetes?s.find(".training-platform").closest(".form-group").show():s.find(".training-platform").closest(".form-group").hide(),t.useKubernetes?(s.find(".training-cpus, .training-gpus").closest(".form-group").show(),s.find(".training-coretype, .training-cores").closest(".form-group").hide()):(s.find(".training-cpus, .training-gpus").closest(".form-group").hide(),t.useRescale?s.find(".training-coretype, .training-cores").closest(".form-group").show():s.find(".training-coretype, .training-cores").closest(".form-group").hide()),setTimeout(function(){s.css({top:"0"}),s.fadeIn()},500);var r=!1,i=!1;function d(){r&&i&&(s.find(".form-group.considerable div").animate({opacity:1},500),s.find(".btn").removeClass("disabled"))}API("Notebook").getIPythonNotebooks(training.id,function(o,e,t){if(!app.shouldExit(t,o)){t.body.sort(function(o,e){return o.name<e.name?-1:o.name>e.name?1:0});var n="";$.map(t.body,function(o){n+='<option value="'+o.name+'">'+o.name+"</option>"}),""==n&&(n+='<option value="none">There is no notebook in your workspace.</option>');var i=s.find(".training-type select"),a=s.find(".training-notebook select").html(n);0==t.body.length?(i.val("1").prop("disabled",!0),a.prop("disabled",!0),s.find(".training-cmds").focus(),training.cmd=""):(i.val("0").removeProp("disabled"),a.removeProp("disabled"),training.cmd="python <converted-notebook.py>"),i.formSelect(),a.formSelect(),r=!0,d()}}),API("Rescale").getRescaleCoreTypes({appVer:"cpu:cheap"},function(o,e,t){if(app.shouldExit(t,o)||t&&t.body&&401==t.body.code)return i=!0,void d();var n="";0<t.body.length&&$.map(t.body[0].resources,function(o){var e=0<o.gpus?", GPU: "+o.gpus:"";n+='<option value="'+o.cores+'">CPU cores: '+o.cores+e+"</option>"}),s.find(".training-cores select").html(n).formSelect(),i=!0,d()})},stop:function(o){confirmation.action="STOP",confirmation.id=app.trim($(o.target).closest("li").attr("data-id")),confirmation.name=$(o.target).closest("li").find(".notebook-name").text(),$("#notebook-modify").modal("open")},del:function(o){confirmation.action="DELETE",confirmation.id=app.trim($(o.target).closest("li").attr("data-id")),confirmation.name=$(o.target).closest("li").find(".notebook-name").text(),$("#notebook-modify").modal("open")},update:function(){var e=[];$.map(notebooks,function(o){(""==conditions.words||app.match([o.image,o.name],conditions.words))&&"created"!=o.state&&e.push(o)}),e.sort(function(o,e){if(1==conditions.order){if(o.image<e.image)return-1;if(o.image>e.image)return 1}var t=new Date(e.started).getTime()-new Date(o.started).getTime();return 0!=t?t:o.image<e.image?-1:o.image>e.image?1:0});var t=[];$.map(e,function(o){var e=o.port?window.location.protocol+"//"+window.location.hostname+":"+o.port:"";t.push({id:o.id,name:o.name.substring(1),image:o.image,url:e,state:o.state,started:app.date.format(new Date(o.started)),classObject:statusClass(o.state)})}),this.notebooks=t,conditions.firstLoad&&(conditions.firstLoad=!1,""!=conditions.words&&0<t.length&&setTimeout(function(){$("#query-words").blur()},750)),$("#record-count").text(t.length)}}});function statusClass(o){switch(o){case"running":return{"label-success":!0,"label-warning":!1,"label-danger":!1};case"creating":return{"label-success":!1,"label-warning":!0,"label-danger":!1};case"exited":return{"label-success":!1,"label-warning":!1,"label-danger":!0}}return{"label-success":!1,"label-warning":!1,"label-danger":!0}}function update(){conditions.words=app.singleSpace($("#query-words").val()),conditions.order=parseInt($("#query-order-type").val(),10),vue.update()}function load(n){API("Notebook").getNotebooks(function(o,e,t){$.isEmptyObject(o)&&t&&t.body&&(notebooks=t.body,update(),n&&n())})}function loadDetails(s){if(!$(s).attr("data-loaded")){var o=$(s).attr("data-id");API("Notebook").getNotebookDetails(o,function(o,e,t){if(!app.shouldExit(t,o)){var n=$("a.endpoint",s);if(!t.body.token)return setTimeout(function(){loadDetails(s)},1e3),void n.prop("href","");n.prop("href",s.closest("li").attr("data-url")+"?token="+t.body.token),$(".notebook-name",s).text(t.body.name.substring(1)),$(".notebook-started",s).text(app.date.format(new Date(t.body.started)));var i="-";"exited"==t.body.state&&(i=app.date.format(new Date(t.body.ended))),$(".notebook-ended",s).text(i);var a=0<t.body.mounts.length?t.body.mounts[0]:"";0<a.indexOf(":")&&(a=a.split(":"),a='<a href="/workspaces/?q='+encodeURIComponent(a[0])+'">'+a[0]+"</a>:"+a[1]),$(".notebook-volumes",s).html(a),$(s).attr("data-loaded","done")}})}}var training=new Vue({el:"#training-dialog",data:{id:"",name:"",cmd:"",cpus:1024,memory:0,gpus:0},methods:{submit:function(){setTimeout(function(){$(".btn").blur()},500),$("form p.errors").show();var n=$("#training-dialog"),o=app.singleSpace(this.cmd).split(" ");if(!o||0==o.length||""==o[0])return M.toast({html:"You have to specify its commands.",displayLength:3e3}),void n.find(".training-cmds").focus();$("#act-submit").addClass("disabled").prop("disabled",!0),n.find(".cancel").addClass("disabled").prop("disabled",!0),n.find(".modal-footer div.col-12").css({opacity:"0.4"}),n.find("section.wait-icon").show();var e=models.JobAttrs.PlatformIdEnum.kubernetes,t=n.find(".training-notebook select").val();"1"==n.find(".training-platform select").val()&&(e=models.JobAttrs.PlatformIdEnum.rescale),"1"==n.find(".training-type select").val()&&(t="none");var i=models.JobAttrs.constructFromObject({platform_id:e,notebook_id:this.id,entrypoint_file:t,commands:o,cpu:this.cpus,mem:this.memory,gpu:this.cpus,coretype:n.find(".training-coretype select").val(),cores:parseInt(n.find(".training-cores select").val(),10)});API("Job").postNewJob(i,function(o,e,t){if(!$.isEmptyObject(o))return t&&t.body&&t.body.code&&"400"==t.body.code&&t.body.message?(n.modal("close"),$("#act-submit").removeClass("disabled").removeProp("disabled"),n.find(".cancel").removeClass("disabled").removeProp("disabled",!0),n.find(".modal-footer div.col-12").css({opacity:"1.0"}),n.find("section.wait-icon").hide(),void M.toast({html:"Could not start training with this notebook",displayLength:3e3})):app.shouldExit(t,o)?(alert("Something went wront. Check your configurations!"),void(window.location.href="/settings/")):void 0;location.href="/jobs/?q="+encodeURIComponent(t.body.id)})},error:function(o){this.msgCmd=o},close:function(){$("#training-dialog").modal("close")}}}),confirmation=new Vue({el:"#notebook-modify",data:{action:"STOP",id:"",name:""},methods:{exec:function(){switch($("#notebook-modify").modal("close"),this.action){case"STOP":var o=models.NotebookAttrs.constructFromObject({status:"stopped"});API("Notebook").modifyNotebook(this.id,o,function(o,e,t){if(!$.isEmptyObject(o)){var n="Could not stop the specified notebook";return t&&t.body&&t.body.message&&(n=t.body.message),void M.toast({html:n,displayLength:3e3})}M.toast({html:"Stoped successfully. [ "+confirmation.name+" ]",displayLength:3e3}),load()});break;case"DELETE":API("Notebook").deleteNotebook(this.id,function(o,e,t){if(!$.isEmptyObject(o)){var n="Could not delete the specified notebook";return t&&t.body&&t.body.message&&(n=t.body.message),void M.toast({html:n,displayLength:3e3})}M.toast({html:"Deleted successfully. [ "+confirmation.name+" ]",displayLength:3e3}),load()})}},close:function(){$("#notebook-modify").modal("close")}}});$(document).ready(function(){$("#menu-notebooks").addClass("active"),app.query("q")&&$("#query-words").val(app.query("q")).focus(),$(".collapsible").on("shown.bs.collapse",function(o){loadDetails($(o.target).closest("li"))});var o=config.get();vue.trainOnCloud=o.useRescale||o.useKubernetes,load(function(){$("#query-words").keyup(function(){update()}),$("#query-order-type").change(function(){update()}),$("#training-dialog .training-platform select").on("change",function(){var o=$("#training-dialog");"0"==$(this).val()?(o.find(".training-cpus, .training-gpus").closest(".form-group").show(),o.find(".training-coretype, .training-cores").closest(".form-group").hide()):(o.find(".training-cpus, .training-gpus").closest(".form-group").hide(),o.find(".training-coretype, .training-cores").closest(".form-group").show())}),$("#training-dialog .training-type select").on("change",function(){var o=$("#training-dialog");"1"==$(this).val()?(o.find(".training-notebook select").prop("disabled",!0).formSelect(),o.find(".training-cmds").focus(),training.cmd=""):(o.find(".training-notebook select").removeProp("disabled").formSelect(),training.cmd="python <converted-notebook.py>")}),$("#training-dialog .training-coretype select").on("change",function(){var i=$("#training-dialog"),o="cpu:cheap";"dolomite"==$(this).val()&&(o="gpu:volta"),API("Rescale").getRescaleCoreTypes({appVer:o},function(o,e,t){if(app.shouldExit(t,o)||t&&t.body&&401==t.body.code)return alert("Something went wront. Check your configurations!"),void(window.location.href="/settings/");var n="";0<t.body.length&&$.map(t.body[0].resources,function(o){var e=0<o.gpus?", GPU: "+o.gpus:"";n+='<option value="'+o.cores+'">CPU cores: '+o.cores+e+"</option>"}),i.find(".training-cores select").html(n).formSelect()})}),$("#data").fadeIn()}),setInterval(load,3e3)});