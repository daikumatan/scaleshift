var notebooks=[],conditions={firstLoad:!0,words:"",order:1},vue=new Vue({el:"#data",data:{notebooks:[]},methods:{train:function(o){var e=$(o.target).closest("li");training.id=e.attr("data-id"),training.name=e.find(".notebook-name").text(),training.cmd="";var d=$("#training-dialog");d.find(".form-group.considerable div").css({opacity:0}),d.find(".btn").addClass("disabled"),d.find(".training-notebook select").html(""),d.modal("open");var s=!1,a=!1;function r(){s&&a&&(d.find(".form-group.considerable div").animate({opacity:1},500),d.find(".btn").removeClass("disabled"))}API("Notebook").getIPythonNotebooks(training.id,function(o,e,t){if(!app.shouldExit(t,o)){t.body.sort(function(o,e){return o.name<e.name?-1:o.name>e.name?1:0});var n="";$.map(t.body,function(o){n+='<option value="'+o.name+'">'+o.name+"</option>"}),""==n&&(n+='<option value="none">There is no notebook in your workspace.</option>');var a=d.find(".training-type select"),i=d.find(".training-notebook select").html(n);0==t.body.length?(a.val("1").prop("disabled",!0),i.prop("disabled",!0),d.find(".training-cmds").focus(),training.cmd=""):(a.val("0").removeProp("disabled"),i.removeProp("disabled"),training.cmd="python <converted-notebook.py>"),a.formSelect(),i.formSelect(),s=!0,r()}}),API("Rescale").getCoreTypes({appVer:"cpu:cheap"},function(o,e,t){if(app.shouldExit(t,o)||t&&t.body&&401==t.body.code)auth.exit();else{var n="";0<t.body.length&&$.map(t.body[0].resources,function(o){var e=0<o.gpus?", GPU: "+o.gpus:"";n+='<option value="'+o.cores+'">CPU cores: '+o.cores+e+"</option>"}),d.find(".training-cores select").html(n).formSelect(),a=!0,r()}})},stop:function(o){confirmation.action="STOP",confirmation.id=app.trim($(o.target).closest("li").attr("data-id")),confirmation.name=$(o.target).closest("li").find(".notebook-name").text(),$("#notebook-modify").modal("open")},del:function(o){confirmation.action="DELETE",confirmation.id=app.trim($(o.target).closest("li").attr("data-id")),confirmation.name=$(o.target).closest("li").find(".notebook-name").text(),$("#notebook-modify").modal("open")},update:function(){var e=[];$.map(notebooks,function(o){(""==conditions.words||app.match([o.image,o.name],conditions.words))&&"created"!=o.state&&e.push(o)}),e.sort(function(o,e){if(1==conditions.order){if(o.image<e.image)return-1;if(o.image>e.image)return 1}var t=new Date(e.started).getTime()-new Date(o.started).getTime();return 0!=t?t:o.image<e.image?-1:o.image>e.image?1:0});var t=[];$.map(e,function(o){var e=o.port?window.location.protocol+"//"+window.location.hostname+":"+o.port:"";t.push({id:o.id,name:o.name.substring(1),image:o.image,url:e,state:o.state,started:app.date.format(new Date(o.started)),classObject:statusClass(o.state)})}),this.notebooks=t,conditions.firstLoad&&(conditions.firstLoad=!1,""!=conditions.words&&0<t.length&&setTimeout(function(){$("#query-words").blur()},500)),$("#record-count").text(t.length)}}});function statusClass(o){switch(o){case"running":return{"label-success":!0,"label-warning":!1,"label-danger":!1};case"creating":return{"label-success":!1,"label-warning":!0,"label-danger":!1};case"exited":return{"label-success":!1,"label-warning":!1,"label-danger":!0}}return{"label-success":!1,"label-warning":!1,"label-danger":!0}}function update(){conditions.words=app.singleSpace($("#query-words").val()),conditions.order=parseInt($("#query-order-type").val(),10),vue.update()}function load(n){API("Notebook").getNotebooks(function(o,e,t){$.isEmptyObject(o)&&t&&t.body&&(notebooks=t.body,update(),n&&n())})}function loadDetails(d){if(!$(d).attr("data-loaded")){var o=$(d).attr("data-id");API("Notebook").getNotebookDetails(o,function(o,e,t){if(!app.shouldExit(t,o)){var n=$("a.endpoint",d);if(!t.body.token)return setTimeout(function(){loadDetails(d)},1e3),void n.prop("href","");n.prop("href",d.closest("li").attr("data-url")+"?token="+t.body.token),$(".notebook-name",d).text(t.body.name.substring(1)),$(".notebook-started",d).text(app.date.format(new Date(t.body.started)));var a="-";"exited"==t.body.state&&(a=app.date.format(new Date(t.body.ended))),$(".notebook-ended",d).text(a);var i=0<t.body.mounts.length?t.body.mounts[0]:"";0<i.indexOf(":")&&(i=i.split(":"),i='<a href="/workspaces/?q='+encodeURIComponent(i[0])+'">'+i[0]+"</a>:"+i[1]),$(".notebook-volumes",d).html(i),$(d).attr("data-loaded","done")}})}}var training=new Vue({el:"#training-dialog",data:{id:"",name:"",cmd:""},methods:{submit:function(){setTimeout(function(){$(".btn").blur()},500),$("form p.errors").show();var o=$("#training-dialog"),e=app.singleSpace(this.cmd).split(" ");if(!e||0==e.length||""==e[0])return M.toast({html:"You have to specify its commands.",displayLength:3e3}),void o.find(".training-cmds").focus();o.modal("close");var t=o.find(".training-notebook select").val();"1"==o.find(".training-type select").val()&&(t="none");var n=models.JobAttrs.constructFromObject({notebook_id:this.id,entrypoint_file:t,commands:e,coretype:o.find(".training-coretype select").val(),cores:parseInt(o.find(".training-cores select").val(),10)});API("Job").postNewJob(n,function(o,e,t){if(!$.isEmptyObject(o))return t&&t.body&&t.body.code&&"400"==t.body.code&&t.body.message?void M.toast({html:"Could not start training with this notebook",displayLength:3e3}):t&&t.body&&t.body.code&&"406"==t.body.code&&t.body.message?void M.toast({html:"GPU is not allowed yet",displayLength:3e3}):app.shouldExit(t,o)?void auth.exit():void 0;location.href="/jobs/?q="+encodeURIComponent(t.body.id)})},error:function(o){this.msgCmd=o},close:function(){$("#training-dialog").modal("close")}}}),confirmation=new Vue({el:"#notebook-modify",data:{action:"STOP",id:"",name:""},methods:{exec:function(){switch($("#notebook-modify").modal("close"),this.action){case"STOP":var o=models.NotebookAttrs.constructFromObject({status:"stopped"});API("Notebook").modifyNotebook(this.id,o,function(o,e,t){if(!$.isEmptyObject(o)){var n="Could not stop the specified notebook";return t&&t.body&&t.body.message&&(n=t.body.message),void M.toast({html:n,displayLength:3e3})}M.toast({html:"Stoped successfully. [ "+confirmation.name+" ]",displayLength:3e3}),load()});break;case"DELETE":API("Notebook").deleteNotebook(this.id,function(o,e,t){if(!$.isEmptyObject(o)){var n="Could not delete the specified notebook";return t&&t.body&&t.body.message&&(n=t.body.message),void M.toast({html:n,displayLength:3e3})}M.toast({html:"Deleted successfully. [ "+confirmation.name+" ]",displayLength:3e3}),load()})}},close:function(){$("#notebook-modify").modal("close")}}});$(document).ready(function(){$("#menu-notebooks").addClass("active"),app.query("q")&&$("#query-words").val(app.query("q")).focus(),$(".collapsible").on("shown.bs.collapse",function(o){loadDetails($(o.target).closest("li"))}),load(function(){$("#query-words").keyup(function(){update()}),$("#query-order-type").change(function(){update()}),$("#training-dialog .training-type select").on("change",function(){var o=$("#training-dialog");"1"==$(this).val()?(o.find(".training-notebook select").prop("disabled",!0).formSelect(),o.find(".training-cmds").focus(),training.cmd=""):(o.find(".training-notebook select").removeProp("disabled").formSelect(),training.cmd="python <converted-notebook.py>")}),$("#training-dialog .training-coretype select").on("change",function(){var a=$("#training-dialog"),o="cpu:cheap";"dolomite"==$(this).val()&&(o="gpu:volta"),API("Rescale").getCoreTypes({appVer:o},function(o,e,t){if(app.shouldExit(t,o)||t&&t.body&&401==t.body.code)auth.exit();else{var n="";0<t.body.length&&$.map(t.body[0].resources,function(o){var e=0<o.gpus?", GPU: "+o.gpus:"";n+='<option value="'+o.cores+'">CPU cores: '+o.cores+e+"</option>"}),a.find(".training-cores select").html(n).formSelect()}})}),$("#data").fadeIn()}),setInterval(load,3e3)});